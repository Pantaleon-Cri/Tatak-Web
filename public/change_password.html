<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Change Password</title>
  <style>
    :root{
      --accent:#06b6d4; 
      --radius:14px; 
      --max-width:480px; 
      font-family: Inter, sans-serif;
    }
    *{box-sizing:border-box;}
    body{
      margin:0; 
      display:flex; 
      justify-content:center; 
      align-items:center; 
      height:100vh; 
      background: url('background.png') no-repeat center center fixed; 
      background-size: cover;
    }
    .container{
      width:100%; 
      max-width:var(--max-width); 
      background:#fff; 
      padding:28px; 
      border-radius:var(--radius); 
      box-shadow:0 5px 20px rgba(0,0,0,0.25);
    }
    h1{
      margin-top:0; 
      margin-bottom:18px; 
      font-size:22px; 
      color:#111;
    }
    .field{
      margin-bottom:18px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    label{
      font-size:14px;
      font-weight:500;
      color:#333;
    }
    input{
      width:100%; 
      padding:12px 14px; 
      border-radius:10px; 
      border:1px solid #ccc; 
      font-size:15px; 
      outline:none;
      transition: all 0.2s;
    }
    input:focus{
      border-color: var(--accent);
      box-shadow:0 0 0 3px rgba(6,182,212,0.3);
    }
    .btn{
      width:100%; 
      padding:12px; 
      border:none; 
      border-radius:10px; 
      background:var(--accent); 
      color:#fff; 
      font-weight:600; 
      font-size:16px;
      cursor:pointer;
      transition: all 0.2s;
    }
    .btn:hover{
      background: #0aa5c0;
    }
    .message{
      margin-top:12px; 
      padding:12px; 
      border-radius:10px; 
      display:none; 
      font-size:14px;
    }
    .message.show{display:block;}
    .message.success{
      background:#e6f9f0; 
      color:#065f46; 
      border:1px solid #10b981;
    }
    .message.error{
      background:#fdecea; 
      color:#7f1d1d; 
      border:1px solid #ef4444;
    }

    @media (max-width: 1024px){
      body{ padding:20px; }
      .container{ max-width: 100%; }
    }
    @media (max-width: 768px){
      .container{ padding:20px; }
    }
  </style>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
</head>
<body>
<div class="container">
  <h1>Change Password</h1>
  <form id="change-form">
    <div class="field">
      <label for="password">New Password</label>
      <input id="password" type="password" placeholder="Enter new password" required>
    </div>
    <div class="field">
      <label for="confirm">Confirm Password</label>
      <input id="confirm" type="password" placeholder="Confirm new password" required>
    </div>
    <button type="submit" class="btn">Change Password</button>
    <div id="msg" class="message"></div>
  </form>
</div>

<script>
  // Firebase config and init
  const firebaseConfig = {
    apiKey: "AIzaSyDdSSYjX1DHKskbjDOnnqq18yXwLpD3IpQ",
    authDomain: "tatak-mobile-web.firebaseapp.com",
    projectId: "tatak-mobile-web",
    storageBucket: "tatak-mobile-web.appspot.com",
    messagingSenderId: "771908675869",
    appId: "1:771908675869:web:88e68ca51ed7ed4da019f4",
    measurementId: "G-CENPP29LKQ"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const form = document.getElementById("change-form");
  const msg = document.getElementById("msg");

  // Extract query parameters
  const urlParams = new URLSearchParams(window.location.search);
  const userID = urlParams.get("userID");     // for designees
  const schoolId = urlParams.get("schoolId"); // for students

  function showMessage(text, type){
    msg.textContent = text;
    msg.className = 'message show ' + type;
  }

  form.addEventListener("submit", async function(e){
    e.preventDefault();
    const password = document.getElementById("password").value.trim();
    const confirm = document.getElementById("confirm").value.trim();

    if(!password || !confirm){
      showMessage("Fill in all fields",'error'); 
      return;
    }
    if(password !== confirm){
      showMessage("Passwords do not match",'error'); 
      return;
    }

    try{
      if(userID){ 
        // Update designee password
        const snapshot = await db.collection("User").doc("Designees")
          .collection("DesigneesDocs")
          .where("userID", "==", userID)
          .get();

        if(snapshot.empty) throw new Error("User not found");
        const docId = snapshot.docs[0].id;

        await db.collection("User").doc("Designees")
          .collection("DesigneesDocs")
          .doc(docId)
          .update({ password: password });

      } else if(schoolId){
        // Update student password
        const snapshot = await db.collection("User").doc("Students")
          .collection("StudentsDocs")
          .where("schoolId", "==", schoolId)
          .get();

        if(snapshot.empty) throw new Error("User not found");
        const docId = snapshot.docs[0].id;

        await db.collection("User").doc("Students")
          .collection("StudentsDocs")
          .doc(docId)
          .update({ password: password });

      } else {
        showMessage("Invalid or missing identifier.", "error");
        return;
      }

      showMessage("Password successfully updated!","success");
      form.reset();

    } catch(err){
      console.error(err);
      showMessage("Error updating password",'error');
    }
  });
</script>
</body>
</html>
